<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
 * 
 * <pre>
 * 
 * </pre>
 * 
 * < 개정이력 >
 * 
 *  수정일			수정자			수정내용
 *  ================================================
 *  2025-09-19		KCY				최초 생성
-->
<mapper namespace="kr.letech.study.board.dao.BoardDAO">
	<sql id="search">
		<if test='term neq "default" and keyword eq 0'>
			AND (USER_ID LIKE CONCAT('%', #{term}, '%')
		   		OR
		   		USER_NM LIKE CONCAT('%', #{term}, '%')
		   		OR
		   		POST_TITLE LIKE CONCAT('%', #{term}, '%')
		   		OR
		   		POST_CONTENT LIKE CONCAT('%', #{term}, '%')	)
	   	</if>
	   	<if test='term neq "default" and keyword eq 1'>
	   		AND USER_ID LIKE CONCAT('%', #{term}, '%')
	   	</if>
	   	<if test='term neq "default" and keyword eq 2'>
	   		AND USER_NM LIKE CONCAT('%', #{term}, '%')
	   	</if>
	   	<if test='term neq "default" and keyword eq 3'>
	   		AND (POST_TITLE LIKE CONCAT('%', #{term}, '%')
	   			OR
	   			POST_CONTENT LIKE CONCAT('%', #{term}, '%')	)
	   	</if>
	   	<if test='term neq "default" and keyword eq 4'>
	   		AND POST_TITLE LIKE CONCAT('%', #{term}, '%')
	   	</if>
	   	<if test='term neq "default" and keyword eq 5'>
	   		AND POST_CONTENT LIKE CONCAT('%', #{term}, '%')
	   	</if>
	</sql>

	<sql id="postsColumns">
		POST_ID
		, USER_ID
		, BOARD_CD
		, POST_TITLE
		, POST_CONTENT
		, POST_PARENT_ID
		, HIDDEN_YN
		, CMT_YN
		, BANNED_YN
		, ATTACH_GRP_ID
		, RGST_ID
		, RGST_DT
		, UPDT_ID
		, UPDT_DT
		, DEL_YN
	</sql>
	<sql id="postsInsert">
		#{postId}
		, #{userId}
		, #{boardCd}
		, #{postTitle}
		, #{postContent}
		, #{postParentId}
		, #{hiddenYn}
		, #{cmtYn}
		, #{bannedYn}
		, #{attachGrpId}
		, #{rgstId}
		, NOW()
		, #{updtId}
		, NOW()
		, 'N'
	</sql>
	<sql id="commentsColumns">
		CMT_ID
		, POST_ID
		, USER_ID
		, CMT_CONTENT
		, CMT_PARENT_ID
		, CMT_DEPTH
		, CMT_ORDER
		, HIDDEN_YN
		, BANNED_YN
		, RGST_ID
		, RGST_DT
		, UPDT_ID
		, UPDT_DT
		, DEL_YN
	</sql>
	<sql id="commentsInsert">
		#{cmtId}
		, #{postId}
		, #{userId}
		, #{cmtContent}
		, #{cmtParentId}
		, #{cmtDepth}
		, #{cmtOrder}
		, #{hiddenYn}
		, #{bannedYn}
		, #{rgstId}
		, NOW()
		, #{updtId}
		, NOW()
		, 'N'
	</sql>

	<select id="selectPostList" resultType="kr.letech.study.board.vo.PostsVO">
	/** kr.letech.study.board.dao.BoardDAO .readPostList() - KCY */
	
		SELECT <include refid="postsColumns" />
		  FROM POSTS
		 WHERE DEL_YN = 'N'
			<include refid="search" />
			
	</select>
	
	<select id="selectPostDetail" parameterType="string" resultType="kr.letech.study.board.vo.PostsVO">
	/** kr.letech.study.board.dao.BoardDAO .readPostDetail() - KCY */
	
		SELECT <include refid="postsColumns" />
		  FROM POSTS
		 WHERE DEL_YN = 'N'
		   AND POST_ID = #{postId}
		   
	</select>
	
	<insert id="insertPost" parameterType="kr.letech.study.board.vo.PostsVO">
	/** kr.letech.study.board.dao.BoardDAO .insertPost() - KCY */
	
		<selectKey keyProperty="postId" resultType="string" order="BEFORE">
			SELECT CONCAT(
						'BD'
					<if test="boardCd eq 'AB010'">
						, 'F'
					</if>
						, DATE_FORMAT(NOW(), '%y%m%d')
						, LPAD(NEXT VALUE FOR POST_SEQ, 5, '0')
				   )
		</selectKey>
		INSERT INTO POSTS (
			<include refid="postsColumns" />
		) VALUES (
			<include refid="postsInsert" />
		)
		
	</insert>
	
	<update id="updatePost" parameterType="kr.letech.study.board.vo.PostsVO">
	/** kr.letech.study.board.dao.BoardDAO .updatePost() - KCY */
		
		UPDATE POSTS
		   SET POST_TITLE		= #{postTitle}
		     , POST_CONTENT		= #{postContent}
		     , HIDDEN_YN		= #{hiddenYn}
		     , CMT_YN			= #{cmtYn}
		     , UPDT_ID			= #{updtId}
		     , UPDT_DT			= NOW()
		 WHERE POST_ID = #{postId}
		   AND DEL_YN = 'N'
	
	</update>
	
	<update id="deletePost" parameterType="string">
	/** kr.letech.study.board.dao.BoardDAO .deletePost() - KCY */
	
		UPDATE POSTS
		   SET DEL_YN = 'Y'
		 WHERE POST_ID = #{postId}
		 
	</update>
	
	
	<select id="selectComment" parameterType="string" resultType="kr.letech.study.board.vo.CommentsVO">
	/** kr.letech.study.board.dao.BoardDAO .selectComment() - KCY */

		SELECT <include refid="commentsColumns" />
		  FROM COMMENTS
		 WHERE DEL_YN = 'N'
		   AND CMT_ID = #{cmtId}
	
	</select>
	
	<select id="selectCommentList" parameterType="String" resultType="kr.letech.study.board.vo.CommentsVO">
	/** kr.letech.study.board.dao.BoardDAO .selectCommentList() - KCY */
	
		WITH RECURSIVE cmt_tree AS (
		-- ROOT-COMMENT (DEPTH = 0)
		SELECT R.CMT_ID
			 , R.POST_ID
			 , R.USER_ID
			 , R.CMT_CONTENT
			 , R.CMT_PARENT_ID
			 , 0 AS CMT_DEPTH	-- JSP에서 margin-left 처리해주기 위해 기본값 처리
			 -- , CAST( LPAD(R.CMT_ORDER, 5, '0' ) AS CHAR(200) ) AS CMT_PATH
			 , LPAD(R.CMT_ORDER, 5, '0' ) AS CMT_PATH
			 , R.HIDDEN_YN
			 , R.BANNED_YN
			 , R.RGST_ID
			 , R.RGST_DT
			 , R.UPDT_ID
			 , R.UPDT_DT
			 , R.DEL_YN
		  FROM COMMENTS R
		 WHERE R.DEL_YN = 'N'
		   AND R.POST_ID = #{postId}
		   AND R.CMT_PARENT_ID IS NULL
		
		UNION ALL
		-- CHILD-COMMENTS (DEPTH = 1)
		
		SELECT C.CMT_ID
			 , C.POST_ID
			 , C.USER_ID
			 , C.CMT_CONTENT
			 , C.CMT_PARENT_ID
			 , P.CMT_DEPTH + 1 AS CMT_DEPTH
			 , CONCAT( P.CMT_PATH, '-', LPAD(C.CMT_ORDER, 5, '0') ) AS CMT_PATH
			 , C.HIDDEN_YN
			 , C.BANNED_YN
			 , C.RGST_ID
			 , C.RGST_DT
			 , C.UPDT_ID
			 , C.UPDT_DT
			 , C.DEL_YN
		  FROM COMMENTS C
		 INNER JOIN CMT_TREE P ON ( C.CMT_PARENT_ID = P.CMT_ID )
		 WHERE C.DEL_YN = 'N'
		)
		
		SELECT CMT_ID
			 , POST_ID
			 , USER_ID
			 , CMT_CONTENT
			 , CMT_PARENT_ID
			 , CMT_DEPTH
			 , CMT_PATH
			 , HIDDEN_YN
			 , BANNED_YN
			 , RGST_ID
			 , RGST_DT
			 , UPDT_ID
			 , UPDT_DT
			 , DEL_YN
		  FROM cmt_tree
		 ORDER BY CMT_PATH
	
	</select>
	
	<insert id="insertComment" parameterType="kr.letech.study.board.vo.CommentsVO">
	/** kr.letech.study.board.dao.BoardDAO .insertComment() - KCY */
	
		<selectKey keyProperty="cmtId" resultType="string" order="BEFORE">
			SELECT CONCAT(
						'CMT'
						, DATE_FORMAT(NOW(), '%y%m%d')
						, LPAD(NEXT VALUE FOR POST_SEQ, 5, '0')
				   )
		</selectKey>
		INSERT INTO COMMENTS(
			<include refid="commentsColumns" />
		) VALUES (
			<include refid="commentsInsert" />
		)
	
	</insert>
	
	<update id="updateComment" parameterType="kr.letech.study.board.vo.CommentsVO">
	/** kr.letech.study.board.dao.BoardDAO .updateComment() - KCY */
	
		UPDATE COMMENTS
		   SET CMT_CONTENT	= #{cmtContent}
		     , UPDT_ID		= #{updtId}
		     , UPDT_DT		= NOW()
		 WHERE DEL_YN = 'N'
		   AND CMT_ID = #{cmtId}
		   
	</update>
	
	<update id="deleteComment" parameterType="string">
	/** kr.letech.study.board.dao.BoardDAO .deleteComment() - KCY */
	
		UPDATE COMMENTS
		   SET DEL_YN		= 'Y'
		     , UPDT_ID		= #{userId}
		     , UPDT_DT		= NOW()
		 WHERE CMT_ID = #{cmtId}
		   
	</update>
	
	<select id="selectNextCommentOrder" resultType="integer">
	/** kr.letech.study.board.dao.BoardDAO .selectNextCommentOrder() - KCY */
	
		SELECT COALESCE( MAX(CMT_ORDER), 0 ) + 1
		  FROM COMMENTS
		 WHERE POST_ID = #{postId}
		<if test="cmtParentId == null">
		   AND CMT_PARENT_ID IS NULL
		</if>
		<if test="cmtParentId != null">
		   AND CMT_PARENT_ID = #{cmtParentId}
		</if>
	
	</select>
	
</mapper>